<!DOCTYPE html>
<html>
<head>
    <title>Nocturne v2 WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: #f9f9f9; }
        button { margin: 5px; padding: 8px 16px; }
        .connected { color: green; }
        .disconnected { color: red; }
        .message { color: blue; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Nocturne v2 WebSocket Test</h1>
    <div>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="sendTest()">Send Test Message</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    <div>
        Status: <span id="status" class="disconnected">Disconnected</span>
    </div>
    <div>
        <h3>Log:</h3>
        <div id="log"></div>
    </div>

    <script>
        let ws = null;
        const log = document.getElementById('log');
        const status = document.getElementById('status');

        function addLog(message, className = '') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.innerHTML = `[${timestamp}] ${message}`;
            if (className) div.className = className;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(text, connected = false) {
            status.textContent = text;
            status.className = connected ? 'connected' : 'disconnected';
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('Already connected', 'error');
                return;
            }

            const wsUrl = 'ws://172.16.42.2:5000/ws';
            addLog(`Connecting to ${wsUrl}...`);
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                addLog('Connected successfully!', 'connected');
                updateStatus('Connected', true);
            };

            ws.onmessage = function(event) {
                addLog(`Received: ${event.data}`, 'message');
            };

            ws.onclose = function(event) {
                addLog(`Connection closed: ${event.code} - ${event.reason}`, 'disconnected');
                updateStatus('Disconnected', false);
            };

            ws.onerror = function(error) {
                addLog(`Error: ${error}`, 'error');
                updateStatus('Error', false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                addLog('Disconnected by user');
                updateStatus('Disconnected', false);
            }
        }

        function sendTest() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const testMessage = JSON.stringify({
                    type: 'test',
                    message: 'Hello from Nocturne v2 WebSocket test!',
                    timestamp: new Date().toISOString()
                });
                ws.send(testMessage);
                addLog(`Sent: ${testMessage}`);
            } else {
                addLog('Not connected - cannot send message', 'error');
            }
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // Auto-connect on page load
        window.onload = function() {
            addLog('Page loaded - click Connect to test WebSocket');
        };
    </script>
</body>
</html>