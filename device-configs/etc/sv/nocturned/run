#!/bin/sh

exec 2>&1
sv check dbus > /dev/null || exit 1
sv check bluetoothd > /dev/null || exit 1  
sv check bluetooth_adapter > /dev/null || exit 1

# Quick filesystem check (reduced from 10s to 3s max)
for i in 1 2 3; do
    if touch /var/.test 2>/dev/null; then
        rm -f /var/.test
        break
    fi
    sleep 1
done

# Wait for Bluetooth adapter to be fully ready
echo "Waiting for Bluetooth adapter..."
for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do
    # Check if adapter exists and is powered on
    if bluetoothctl list 2>/dev/null | grep -q Controller && bluetoothctl show 2>/dev/null | grep -q "Powered: yes"; then
        echo "Bluetooth adapter ready after $((i * 3)) seconds"
        # Extra verification - make sure it's really ready
        sleep 2
        if bluetoothctl show 2>/dev/null | grep -q "Powered: yes"; then
            echo "Bluetooth adapter verified as ready"
            break
        fi
    fi
    echo "Bluetooth not ready, waiting... (attempt $i/15)"
    sleep 3
done

# Additional stabilization for Bluetooth stack
sleep 3

# Create log directory if it doesn't exist
mkdir -p /var/nocturne/logs

# Start nocturned with output for debugging
# Redirect to log file and let runsv capture it
exec /usr/local/bin/nocturned 2>&1
